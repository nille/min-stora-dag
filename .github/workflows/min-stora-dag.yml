name: Min Stora Dag Checker

on:
  schedule:
    # Runs every day at 06:30 UTC (07:30 CET, 08:30 CEST during daylight saving)
    - cron: '30 6 * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  check-perfect-day:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install
    
    - name: Install dependencies
      run: uv sync
    
    - name: Check for Min Stora Dag
      id: check
      run: |
        echo "🔍 Checking Heat restaurant menu..."
        # Run with verbose flag to get detailed output in logs
        output=$(uv run python menu_checker.py --verbose)
        echo "$output"
        
        # Extract just the boolean result for the condition check
        result=$(uv run python menu_checker.py)
        echo "result=$result" >> $GITHUB_OUTPUT
        echo "Final result: $result"
        
        # If both dishes found, extract the day and dishes
        if [ "$result" = "True" ]; then
          echo "🎉 Both dishes found! Extracting details..."
          
          # Find the day with both dishes by looking for the "✓ BÅDA RÄTTERNA HITTADE" line
          perfect_day=$(echo "$output" | grep -B 10 "✓ BÅDA RÄTTERNA HITTADE" | grep -E "^[A-ZÅÄÖ][a-zåäö]+:$" | tail -1 | sed 's/:$//')
          echo "perfect_day=$perfect_day" >> $GITHUB_OUTPUT
          
          # Extract all dishes for that day (lines between the day name and "Har pannkakor:")
          dishes=$(echo "$output" | awk "/^$perfect_day:/{flag=1; next} /Har pannkakor:/{flag=0} flag && /^    - / {print substr($0, 7)}")
          echo "dishes<<EOF" >> $GITHUB_OUTPUT
          echo "$dishes" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Perfect day: $perfect_day"
          echo "Dishes found:"
          echo "$dishes"
        fi
    
    - name: Get current week
      id: week
      run: |
        week_number=$(date +%V)
        year=$(date +%Y)
        stockholm_time=$(TZ=Europe/Stockholm date '+%Y-%m-%d %H:%M %Z')
        echo "week=$week_number" >> $GITHUB_OUTPUT
        echo "year=$year" >> $GITHUB_OUTPUT
        echo "stockholm_time=$stockholm_time" >> $GITHUB_OUTPUT
    
    - name: Send Slack notification when both dishes found
      if: steps.check.outputs.result == 'True'
      uses: slackapi/slack-github-action@v1.27.0
      with:
        payload: |
          {
            "text": "🥞✨ MIN STORA DAG! ✨🧀",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "🥞✨ MIN STORA DAG! ✨🧀"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "Fantastiska nyheter! På *${{ steps.check.outputs.perfect_day }}* denna vecka serveras både *pannkakor* OCH *stuvade makaroner* samma dag på Heat restaurang! 🎊"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Perfekta dagen:*\n${{ steps.check.outputs.perfect_day }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Vecka:*\n${{ steps.week.outputs.week }}, ${{ steps.week.outputs.year }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Kontrollerat:*\n${{ steps.week.outputs.stockholm_time }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Nästa steg:*\nRing Heat och boka bord! 🏃‍♂️"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "🍽️ *Alla rätter på ${{ steps.check.outputs.perfect_day }}:*\n${{ steps.check.outputs.dishes }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "📞 Heat Stockholm Asplunden"
                    },
                    "url": "https://heatrestauranger.se/lunch-heat-stockholm-asplunden/"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Create celebratory issue when both dishes found
      if: steps.check.outputs.result == 'True'
      uses: actions/github-script@v7
      with:
        script: |
          const week = '${{ steps.week.outputs.week }}';
          const year = '${{ steps.week.outputs.year }}';
          const stockholmTime = '${{ steps.week.outputs.stockholm_time }}';
          const perfectDay = '${{ steps.check.outputs.perfect_day }}';
          const dishes = '${{ steps.check.outputs.dishes }}';
          
          // Build the dish list
          const dishLines = dishes.split('\n').filter(d => d.trim()).map(d => '- ' + d).join('\n');
          
          // Create the issue body
          let issueBody = '# 🥞✨ DET ÄR DIN STORA DAG! ✨🧀\n\n';
          issueBody += 'Fantastiska nyheter! På **' + perfectDay + '** denna vecka serveras både **pannkakor** OCH **stuvade makaroner** samma dag på Heat restaurang!\n\n';
          issueBody += '## 🍽️ Alla rätter på ' + perfectDay + ':\n';
          issueBody += dishLines + '\n\n';
          issueBody += '## 📅 Information\n';
          issueBody += '- **Perfekta dagen:** ' + perfectDay + '\n';
          issueBody += '- **Vecka:** ' + week + ', ' + year + '\n';
          issueBody += '- **Kontrollerat:** ' + stockholmTime + '\n';
          issueBody += '- **Status:** Båda favoriträtterna hittades samma dag! 🎊\n\n';
          issueBody += '## 🏃‍♂️ Nästa steg\n';
          issueBody += 'Det är dags att boka din lunch på ' + perfectDay + '! Denna magiska kombination händer inte så ofta.\n\n';
          issueBody += 'Ring Heat restaurang och boka bord:\n';
          issueBody += '- **Telefon:** [Heat Stockholm Asplunden](https://heatrestauranger.se/lunch-heat-stockholm-asplunden/)\n\n';
          issueBody += '---\n';
          issueBody += '*Automatiskt genererat av Min Stora Dag workflow* 🤖';
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🎉 MIN STORA DAG! - ' + perfectDay + ', Vecka ' + week + ' ' + year,
            body: issueBody,
            labels: ['min-stora-dag', 'celebration', 'lunch-alert', perfectDay.toLowerCase()]
          });
    
    - name: Send Slack notification when no match found
      if: steps.check.outputs.result == 'False' && vars.SLACK_NOTIFY_NO_MATCH == 'true'
      uses: slackapi/slack-github-action@v1.27.0
      with:
        payload: |
          {
            "text": "😔 Ingen Min Stora Dag idag",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "😔 Ingen Min Stora Dag idag... men hoppet lever!\n\nFortsätter att leta efter den perfekta kombinationen av *pannkakor* och *stuvade makaroner*."
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "Vecka ${{ steps.week.outputs.week }}, ${{ steps.week.outputs.year }} | Kontrollerat: ${{ steps.week.outputs.stockholm_time }}"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Log when no perfect day found
      if: steps.check.outputs.result == 'False'
      run: |
        echo "😔 Ingen Min Stora Dag idag... men hoppet lever!"
        echo "Fortsätter att leta efter den perfekta kombinationen av pannkakor och stuvade makaroner."