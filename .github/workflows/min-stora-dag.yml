name: Min Stora Dag Checker

on:
  schedule:
    # Runs every day at 07:30 UTC (08:30 CET, 09:30 CEST during daylight saving)
    - cron: '30 7 * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  check-perfect-day:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Set up Python
      run: uv python install
    
    - name: Install dependencies
      run: uv sync
    
    - name: Check for Min Stora Dag
      id: check
      run: |
        echo "ğŸ” Checking Heat restaurant menu..."
        # Run with verbose flag to get detailed output in logs
        output=$(uv run python menu_checker.py --verbose)
        echo "$output"
        
        # Extract just the boolean result for the condition check
        result=$(uv run python menu_checker.py)
        echo "result=$result" >> $GITHUB_OUTPUT
        echo "Final result: $result"
        
        # If both dishes found, extract the day and dishes
        if [ "$result" = "True" ]; then
          echo "ğŸ‰ Both dishes found! Extracting details..."
          
          # Find the day with both dishes by looking for the "âœ“ BÃ…DA RÃ„TTERNA HITTADE" line
          perfect_day=$(echo "$output" | grep -B 10 "âœ“ BÃ…DA RÃ„TTERNA HITTADE" | grep -E "^[A-ZÃ…Ã„Ã–][a-zÃ¥Ã¤Ã¶]+:$" | tail -1 | sed 's/:$//')
          echo "perfect_day=$perfect_day" >> $GITHUB_OUTPUT
          
          # Extract all dishes for that day (lines between the day name and "Har pannkakor:")
          dishes=$(echo "$output" | awk "/^$perfect_day:/{flag=1; next} /Har pannkakor:/{flag=0} flag && /^    - / {print substr($0, 7)}")
          echo "dishes<<EOF" >> $GITHUB_OUTPUT
          echo "$dishes" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Perfect day: $perfect_day"
          echo "Dishes found:"
          echo "$dishes"
        fi
    
    - name: Get current week
      id: week
      run: |
        week_number=$(date +%V)
        year=$(date +%Y)
        stockholm_time=$(TZ=Europe/Stockholm date '+%Y-%m-%d %H:%M %Z')
        echo "week=$week_number" >> $GITHUB_OUTPUT
        echo "year=$year" >> $GITHUB_OUTPUT
        echo "stockholm_time=$stockholm_time" >> $GITHUB_OUTPUT
    
    - name: Create celebratory issue when both dishes found
      if: steps.check.outputs.result == 'True'
      uses: actions/github-script@v7
      with:
        script: |
          const week = '${{ steps.week.outputs.week }}';
          const year = '${{ steps.week.outputs.year }}';
          const stockholmTime = '${{ steps.week.outputs.stockholm_time }}';
          const perfectDay = '${{ steps.check.outputs.perfect_day }}';
          const dishes = '${{ steps.check.outputs.dishes }}';
          
          // Build the dish list
          const dishLines = dishes.split('\n').filter(d => d.trim()).map(d => '- ' + d).join('\n');
          
          // Create the issue body
          let issueBody = '# ğŸ¥âœ¨ DET Ã„R DIN STORA DAG! âœ¨ğŸ§€\n\n';
          issueBody += 'Fantastiska nyheter! PÃ¥ **' + perfectDay + '** denna vecka serveras bÃ¥de **pannkakor** OCH **stuvade makaroner** samma dag pÃ¥ Heat restaurang!\n\n';
          issueBody += '## ğŸ½ï¸ Alla rÃ¤tter pÃ¥ ' + perfectDay + ':\n';
          issueBody += dishLines + '\n\n';
          issueBody += '## ğŸ“… Information\n';
          issueBody += '- **Perfekta dagen:** ' + perfectDay + '\n';
          issueBody += '- **Vecka:** ' + week + ', ' + year + '\n';
          issueBody += '- **Kontrollerat:** ' + stockholmTime + '\n';
          issueBody += '- **Status:** BÃ¥da favoritrÃ¤tterna hittades samma dag! ğŸŠ\n\n';
          issueBody += '## ğŸƒâ€â™‚ï¸ NÃ¤sta steg\n';
          issueBody += 'Det Ã¤r dags att boka din lunch pÃ¥ ' + perfectDay + '! Denna magiska kombination hÃ¤nder inte sÃ¥ ofta.\n\n';
          issueBody += 'Ring Heat restaurang och boka bord:\n';
          issueBody += '- **Telefon:** [Heat Stockholm Asplunden](https://heatrestauranger.se/lunch-heat-stockholm-asplunden/)\n\n';
          issueBody += '---\n';
          issueBody += '*Automatiskt genererat av Min Stora Dag workflow* ğŸ¤–';
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸ‰ MIN STORA DAG! - ' + perfectDay + ', Vecka ' + week + ' ' + year,
            body: issueBody,
            labels: ['min-stora-dag', 'celebration', 'lunch-alert', perfectDay.toLowerCase()]
          });
    
    - name: Log when no perfect day found
      if: steps.check.outputs.result == 'False'
      run: |
        echo "ğŸ˜” Ingen Min Stora Dag idag... men hoppet lever!"
        echo "FortsÃ¤tter att leta efter den perfekta kombinationen av pannkakor och stuvade makaroner."